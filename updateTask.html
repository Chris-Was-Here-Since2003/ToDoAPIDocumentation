<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Task</title>
</head>
<body>
  <center>
    <h1>Update Task</h1>

    <div>
      <label for="userId">User ID:</label>
      <input type="number" id="userId" placeholder="Enter User ID">
      <button onclick="loadTasks()">Load Tasks</button>
    </div>
    <br>

    <div>
      <label for="taskSelect">Select Task:</label>
      <select id="taskSelect"></select>
    </div>
    <br>

    <div>
      <input type="text" id="item_name" placeholder="Task Name"><br><br>
      <input type="text" id="item_description" placeholder="Task Description"><br><br>
      <button onclick="updateTask()">Update Task</button>
    </div>
  </center>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    function loadTasks() {
      let userId = $("#userId").val().trim();
      if (!userId) {
        alert("Enter a User ID first.");
        return;
      }

      $.ajax({
        url: `https://todo-list.dcism.org/getItems_action.php?status=active&user_id=${userId}`,
        type: "GET",
        success: function(response) {
          try {
            let res = typeof response === "string" ? JSON.parse(response) : response;

            if (res.status === 200 && res.count > 0) {
              $("#taskSelect").empty();
              let tasks = Object.values(res.data);

              tasks.forEach(task => {
                $("#taskSelect").append(
                  `<option value="${task.item_id}" data-name="${task.item_name}" data-desc="${task.item_description}">
                    ${task.item_name} (ID: ${task.item_id})
                  </option>`
                );
              });

              // auto-fill fields with first task
              let first = tasks[0];
              $("#item_name").val(first.item_name);
              $("#item_description").val(first.item_description);

              $("#taskSelect").off("change").on("change", function() {
                let selected = $(this).find(":selected");
                $("#item_name").val(selected.data("name"));
                $("#item_description").val(selected.data("desc"));
              });

            } else {
              alert("No tasks found for this user.");
            }
          } catch (e) {
            console.error("Unexpected response:", response);
          }
        },
        error: function(xhr, status, error) {
          console.error("Error loading tasks:", status, error);
        }
      });
    }

    function updateTask() {
      let taskId = $("#taskSelect").val();
      let taskName = $("#item_name").val();
      let taskDesc = $("#item_description").val();

      if (!taskId) {
        alert("Select a task first.");
        return;
      }

      $.ajax({
        url: "https://todo-list.dcism.org/editItem_action.php",
        type: "POST",
        data: {
          item_id: taskId,
          item_name: taskName,
          item_description: taskDesc
        }, // ✅ sent as form data (no JSON)
        success: function(response) {
          console.log("Raw edit response:", response);
          try {
            let res = typeof response === "string" ? JSON.parse(response) : response;
            alert("Server: " + res.message);
          } catch (e) {
            alert("Update might have worked, but response wasn’t valid JSON.");
          }
        },
        error: function(xhr, status, error) {
          console.error("Error updating task:", status, error, xhr.responseText);
        }
      });
    }
  </script>
</body>
</html>
